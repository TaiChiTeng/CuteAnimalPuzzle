# 拼图切片算法技术规范

## 概述

本文档详细描述了可爱动物拼图游戏中拼图切片的生成算法。该算法基于《第2版.md》文档中的精确坐标数据，确保拼图切片的准确性和一致性。

**核心理念**：拼图切片的本质是每个切片都要为相邻切片的"凸起"预留空间，同时自己的"凸起"要延伸到相邻切片的区域。

## 算法原理

### 基础概念

1. **基准图片尺寸**: 384x384像素
2. **Mask尺寸**: 拼图切片的基础尺寸，用于定义拼图形状
3. **装饰半径**: 拼图片凸起和凹陷部分的半径
4. **精确坐标**: 基于文档验证的准确坐标数据，不使用算法推导

### 核心参数

基于384x384基准图片的标准参数：

```typescript
const baseMaskSize = 178;           // 基础Mask尺寸
const baseDecorationRadius = 25;    // 基础装饰半径

// 文档中的精确坐标数据（基于384x384图片）
const baseCoordinatesData = {
    3: [0, 103, 231],              // 3x3难度的精确坐标
    4: [0, 77, 154, 231],          // 4x4难度
    5: [0, 62, 124, 186, 248]      // 5x5难度
};
```

## 算法流程

### 1. 缩放比例计算

```typescript
const scale = textureWidth / 384;
```

所有参数都基于384x384基准图片，通过缩放比例适配不同尺寸的图片。

### 2. 参数缩放

```typescript
const maskSize = Math.round(baseMaskSize * scale);
const decorationRadius = Math.round(baseDecorationRadius * scale);
```

### 3. 坐标数组缩放

**关键改进**：直接使用文档中的精确坐标数据，而不是算法推导：

```typescript
const baseCoordinates = baseCoordinatesData[difficulty];
const coordinates = baseCoordinates.map(coord => Math.round(coord * scale));
```

### 4. 切片类型判断

- **角落切片**: 位于四个角落的切片
- **边缘切片**: 位于边缘但非角落的切片  
- **中间切片**: 完全被其他切片包围的切片

### 5. 尺寸计算

```typescript
const edgeSize = maskSize - decorationRadius;  // 边缘切片尺寸 = 178 - 25 = 153
const centerSize = maskSize;                   // 中间切片尺寸 = 178

// 根据切片类型分配尺寸
if (isCorner) {
    rectWidth = edgeSize;
    rectHeight = edgeSize;
} else if (isEdge) {
    if (isTopEdge || isBottomEdge) {
        rectWidth = centerSize;
        rectHeight = edgeSize;
    } else {
        rectWidth = edgeSize;
        rectHeight = centerSize;
    }
} else {
    rectWidth = centerSize;
    rectHeight = centerSize;
}
```

## 算法特点

### 精确性
- **基于文档验证的精确坐标**：使用《第2版.md》中经过验证的坐标数据
- **避免算法推导错误**：不使用可能出错的数学推导，直接使用准确数据
- **确保边界正确**：坐标数据已考虑拼图形状的凸起和凹陷部分

### 可扩展性
- 支持任意尺寸的图片（通过缩放比例）
- 支持3x3、4x4、5x5三种游戏难度
- 易于添加新难度（只需添加对应的坐标数据）

### 性能优化
- 使用缓存机制避免重复计算
- 预定义坐标数据提高效率
- 详细的日志输出便于调试

## 数学公式

### 缩放公式
```
scale = currentImageWidth / 384
scaledValue = baseValue * scale
```

### 坐标缩放公式
```
scaledCoordinates[i] = round(baseCoordinates[i] * scale)
```

### 尺寸计算公式
```
edgeSize = maskSize - decorationRadius
centerSize = maskSize
```

## 验证示例

### 384x384图片，3x3难度（文档基准）
- scale: 1.0
- maskSize: 178
- decorationRadius: 25
- 基础坐标: [0, 103, 231]
- 缩放后坐标: [0, 103, 231]
- edgeSize: 153
- centerSize: 178

### 660x660图片，3x3难度（游戏实际使用）
- scale: 1.719
- maskSize: 306
- decorationRadius: 43
- 基础坐标: [0, 103, 231]
- 缩放后坐标: [0, 177, 397]
- edgeSize: 263
- centerSize: 306

### 660x660图片，4x4难度
- scale: 1.719
- maskSize: 306
- decorationRadius: 43
- 基础坐标: [0, 77, 154, 231]
- 缩放后坐标: [0, 132, 265, 397]
- edgeSize: 263
- centerSize: 306

### 660x660图片，5x5难度
- scale: 1.719
- maskSize: 306
- decorationRadius: 43
- 基础坐标: [0, 62, 124, 186, 248]
- 缩放后坐标: [0, 107, 213, 320, 426]
- edgeSize: 263
- centerSize: 306

### 1024x1024图片，3x3难度
- scale: 2.667
- maskSize: 475
- decorationRadius: 67
- 基础坐标: [0, 103, 231]
- 缩放后坐标: [0, 275, 616]
- edgeSize: 408
- centerSize: 475

### 1024x1024图片，4x4难度
- scale: 2.667
- maskSize: 475
- decorationRadius: 67
- 基础坐标: [0, 77, 154, 231]
- 缩放后坐标: [0, 205, 411, 616]
- edgeSize: 408
- centerSize: 475

### 1024x1024图片，5x5难度
- scale: 2.667
- maskSize: 475
- decorationRadius: 67
- 基础坐标: [0, 62, 124, 186, 248]
- 缩放后坐标: [0, 165, 331, 496, 661]
- edgeSize: 408
- centerSize: 475

## 关键改进

### 从算法推导到数据驱动
- **旧方法**：尝试用数学公式推导坐标，容易出错
- **新方法**：直接使用文档中验证过的精确坐标数据

### 错误避免
- **避免间隔计算错误**：不再使用`textureWidth - maskSize`等可能错误的计算
- **避免边界问题**：使用经过验证的坐标确保切片不会超出边界
- **避免重叠错误**：坐标数据已考虑拼图形状的重叠需求

## 注意事项

1. **数据准确性**: 坐标数据基于《第2版.md》文档验证，确保准确性
2. **四舍五入**: 所有缩放计算结果都进行四舍五入以确保像素对齐
3. **类型安全**: 使用TypeScript严格类型检查
4. **错误处理**: 包含完整的错误检查和日志输出
5. **难度支持**: 目前支持3x3、4x4、5x5三种难度

## 兼容性

- **引擎**: Cocos Creator 3.8.6
- **语言**: TypeScript (ESNext)
- **平台**: 微信小游戏
- **图片格式**: 支持所有Cocos Creator支持的纹理格式
- **图片尺寸**: 完整图片1024x1024，游戏使用660x660

## 性能指标

- **内存占用**: 每个切片约占用基础SpriteFrame内存
- **计算复杂度**: O(n²) 其中n为难度级别
- **缓存效率**: 相同规格的切片只计算一次
- **适用范围**: 支持3x3到5x5难度，可扩展到更高难度